<div class="w-full px-12"
  x-data="{...<%= JSON.stringify({...pageData, showConfirm: ''}) %>,
    _handleFilter: '', 
    publishedMatchesPage: 1,
    get handleFilter() { return this._handleFilter; },
    set handleFilter(val) { this.publishedMatchesPage = 1; this._handleFilter = val; },

    get cleanHandlerFilter () { return this.handleFilter.replace(/@/g, '').toLowerCase(); },
    get sharedMatchesCount() {
      return this.publishedMatches.filter((match) => match.match_status === 'shared').length;
    },

    get selectedMatches() {
      return this.publishedMatches.filter((match) => !this.cleanHandlerFilter || match.santa_handle.toLowerCase().includes(this.cleanHandlerFilter) || match.giftee_handle.toLowerCase().includes(this.cleanHandlerFilter))
    },
    get selectedMatchesStart() { return (this.publishedMatchesPage - 1) * 25; },
    get selectedMatchesEnd() { return Math.min(this.publishedMatchesPage * 25, this.selectedMatches.length);},
    get publishedMatchesPageSelect() { return String(this.publishedMatchesPage); },
    set publishedMatchesPageSelect(strVal) { this.publishedMatchesPage = parseInt(strVal); },
    get publishedMatchesPages() {
      const count = this.selectedMatches.length;
      const pages = [];
      for (let i = 0; i * 25 < count; i++) {
        pages.push({
          key: `${i + 1}`,
          display: `Page ${i + 1}: ${(i * 25) + 1} - ${Math.min((i + 1) * 25, this.selectedMatches.length)}`
        })
      }
      return pages;
    },
  }"
  @ss-match-deactivated.window="publishedMatches = publishedMatches.filter((match) => match.match_id !== event.detail.id)"
>
  <div class="grid sm:grid-cols-2 md:grid-cols-3 sm:space-x-4 space-y-4 sm:space-y-0 justify-center mb-8">
    <form x-show="sharedMatchesCount > 0" hx-post="/match/publish" class="flex items-center sm:justify-center">
      <button type="submit" class="htmx-request:hidden w-lg px-8 py-2 border-4 border-bsky h-full">Publish <span x-text="sharedMatchesCount"></span> addresses</button>
      <%- include('../partials/activity-spinner.ejs') %>
      <input type="hidden" name="current_status" value="shared"/>
      <input type="hidden" name="target_status" value="locked"/>
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>"/>
    </form>
  </div>
  <div class="flex space-x-8 items-center mb-2 flex-col sm:flex-row">
    <h1>Published matches</h1>
    <div>
      <select x-model="publishedMatchesPageSelect">
        <template x-for="{key, display} of publishedMatchesPages">
          <option x-bind:value="key" x-text="display"></option>
        </template>
      </select>
    </div>
  </div>
  <div class="w-full mb-2">
    <input type="text" x-model="handleFilter" placeholder="coolplayer.bsky.social" class="w-full p-1 rounded-lg border"/>
  </div>
  <div class="grid-cols-6 lg:space-x-4 hidden lg:grid">
    <div class="flex justify-center"><b>Santa</b></div>
    <div class="flex justify-center"><b>Giftee</b></div>
    <div class="flex justify-center"><b>Status</b></div>
    <div class="flex justify-center"><b>Nudges</b></div>
    <div class="flex justify-center"><b>Tracking</b></div>
    <div class="flex justify-center"><b>Delete</b></div>
  </div>
  <template x-for="match in selectedMatches.slice(selectedMatchesStart, selectedMatchesEnd)">
    <div class="grid sm:grid-cols-3 lg:grid-cols-6 lg:space-x-4 border-b py-2">
      <div class="flex lg:justify-center items-center text-lg">
        <div class="italic lg:hidden mr-2">Santa:</div>
        <a x-bind:href="'/admin/manage-players?handle=' + encodeURIComponent(match.santa_handle)" target="_blank">
          <span x-text="'@' + match.santa_handle"></span>
          <span x-show="match.santa_deactivated" x-text="match.santa_booted ? 'Booted' : 'Opted-out'" class="font-semibold"></span>
        </a>
      </div>
      <div class="flex lg:justify-center items-center text-lg">
        <div class="italic lg:hidden mr-2">Giftee:</div>
        <a x-bind:href="'/admin/manage-players?handle=' + encodeURIComponent(match.giftee_handle)" target="_blank">
          <span x-text="'@' + match.giftee_handle"></span>
          <span x-show="match.giftee_deactivated" x-text="match.giftee_booted ? 'Booted' : 'Opted-out'" class="font-semibold"></span>
        </a>
      </div>
      <div class="flex lg:justify-center items-center text-lg">
        <div class="italic lg:hidden mr-2">Status:</div>
        <div x-text="match.match_status"></div>
      </div>
      <button x-show="match.match_status === 'locked'" class="flex lg:justify-center items-center text-lg underline">
        <div class="italic lg:hidden mr-2">Nudges:</div>
        <div x-text="match.nudge_count"></div>
      </button>
      <div x-show="match.match_status !== 'locked'" class="col-span-2"></div>
      <div class="hidden sm:block lg:hidden"></div>
      <button x-show="match.match_status === 'locked'" class="flex lg:justify-center items-center text-lg underline">
        <div class="italic lg:hidden mr-2">Tracking:</div>
        <div x-text="match.tracking_count"></div>
      </button>
      <form hx-post="/match/deactivate-match" class="flex items-center sm:justify-center sm:col-span-3 lg:col-span-1">
        <button x-show="`match-${match.match_id}` !== showConfirm" @click.prevent.stop="showConfirm = `match-${match.match_id}`">
          <div class="flex lg:justify-center items-center ">
            <div class="i-mdi-trash-can-outline size-10"></div>
            <div class="lg:hidden"><b>Delete match</b></div>
          </div>
        </button>
        <%- include('../partials/activity-spinner.ejs') %>
        <input x-show="`match-${match.match_id}` === showConfirm" type="submit" name="save" value="Delete match" class="htmx-request:hidden rounded-lg w-lg px-8 py-2 bg-red-600 hover:bg-red-400 text-white drop-shadow-lg focus:ring ring-sky-500 outline-none" />
        <button x-show="`match-${match.match_id}` === showConfirm" @click.prevent.stop="showConfirm = ''" class="htmx-request:hidden">
          <div class="i-mdi-close size-10 text-gray-400"></div>
        </button>
        <input type="hidden" name="match_id" x-bind:value="match.match_id"/>
        <input type="hidden" name="csrfToken" value="<%= csrfToken %>"/>
      </form>
    </div>
  </template>
</div>